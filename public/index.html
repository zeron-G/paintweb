<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana - AI Painter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-zinc-900 text-zinc-100 min-h-screen p-6">
    <div class="max-w-xl mx-auto space-y-6">
        <header class="text-center py-8">
            <h1 class="text-4xl font-black text-yellow-400">ğŸŒ NANO BANANA</h1>
            <p class="text-zinc-400 mt-2">AI äº§å“æ¨¡ç‰¹ç”Ÿæˆå™¨</p>
        </header>

        <div class="bg-zinc-800 p-6 rounded-2xl border border-zinc-700 shadow-2xl">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-zinc-500 mb-2">Google API Key</label>
                    <input type="password" id="apiKey" class="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 outline-none focus:border-yellow-400 transition" placeholder="åœ¨æ­¤ç²˜è´´ä½ çš„å¯†é’¥...">
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-zinc-500 mb-2">ä¸Šä¼ äº§å“å›¾ (å¯é€‰)</label>
                    <div class="relative group">
                        <input type="file" id="refImage" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage()">
                        <div id="uploadBox" class="w-full bg-zinc-900 border border-dashed border-zinc-600 rounded-lg p-4 text-center text-zinc-400 group-hover:border-yellow-400 group-hover:text-yellow-400 transition flex items-center justify-center min-h-[60px]">
                            <span id="uploadText">ç‚¹å‡»ä¸Šä¼ äº§å“ç…§ç‰‡...</span>
                            <img id="preview" class="hidden max-h-32 rounded border border-zinc-700 mx-auto">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-zinc-500 mb-2">ç”Ÿæˆæè¿°</label>
                    <textarea id="prompt" class="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 outline-none focus:border-yellow-400 transition h-24" placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªæ—¶å°šçš„äºšæ´²å¥³æ¨¡ç‰¹æ­£åœ¨è¡—å¤´ä½©æˆ´è¿™æ¬¾äº§å“..."></textarea>
                </div>

                <button onclick="draw()" id="btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-zinc-900 font-black py-4 rounded-xl transition-all transform active:scale-95">
                    ç«‹å³ç”Ÿæˆå›¾ç‰‡
                </button>
            </div>
        </div>

        <div id="display" class="relative group mt-6">
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–ï¼šä»æœ¬åœ°è¯»å– Key
        document.getElementById('apiKey').value = localStorage.getItem('gemini_key') || '';
        let base64Image = null;

        // å›¾ç‰‡é¢„è§ˆå¤„ç†
        function previewImage() {
            const file = document.getElementById('refImage').files[0];
            const preview = document.getElementById('preview');
            const uploadText = document.getElementById('uploadText');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    uploadText.classList.add('hidden');
                    base64Image = e.target.result; // ä¿å­˜ Base64 ä¾›å‘é€
                }
                reader.readAsDataURL(file);
            }
        }

        async function draw() {
            const apiKey = document.getElementById('apiKey').value;
            const prompt = document.getElementById('prompt').value;
            const btn = document.getElementById('btn');
            const display = document.getElementById('display');

            if (!apiKey || !prompt) return alert('è¯·å¡«å†™ API Key å’Œæè¿°');

            // ä¿å­˜ Key
            localStorage.setItem('gemini_key', apiKey);

            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨ç”Ÿæˆä¸­...';
            display.innerHTML = '<div class="h-64 flex items-center justify-center text-zinc-500 border-2 border-dashed border-zinc-700 rounded-2xl italic animate-pulse">AI æ­£åœ¨æ„æ€ç”»é¢...</div>';

            try {
                // æ„å»ºè¯·æ±‚ä½“
                const payload = { apiKey, prompt };
                if (base64Image) {
                    payload.image = base64Image;
                }

                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();

                if (data.image) {
                    display.innerHTML = `<img src="data:image/png;base64,${data.image}" class="w-full rounded-2xl shadow-2xl border-4 border-zinc-800">
                    <a href="data:image/png;base64,${data.image}" download="generated.png" class="block text-center text-zinc-500 mt-2 hover:text-white">ä¸‹è½½å›¾ç‰‡</a>`;
                } else {
                    display.innerHTML = `<div class="p-4 bg-red-900/20 border border-red-500/50 text-red-400 rounded-lg text-sm">ç”Ÿæˆå¤±è´¥: ${data.error}</div>`;
                }
            } catch (e) {
                display.innerHTML = `<div class="text-red-500 text-center">ç½‘ç»œè¯·æ±‚é”™è¯¯: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = 'ç«‹å³ç”Ÿæˆå›¾ç‰‡';
            }
        }
    </script>
</body>
</html>
